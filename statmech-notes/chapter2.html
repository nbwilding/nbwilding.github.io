<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical Physics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter1.html">Chapters</a></li><li class="breadcrumb-item"><a href="./chapter2.html">2. Foundations: equilibrium of an isolated system</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./NotesFigs/courselogo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./course-texts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course texts</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Chapters</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">2. Foundations: equilibrium of an isolated system</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Entropy, equilibrium, and the second Law</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. The Boltzmann distribution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. Free energy minimisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Systems of weakly interacting constituents</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7. More on magnetism; review</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8. Einstein’s model of a simple solid</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9. Ideal gas and indistinguishability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10. Ideal gas in the low density limit</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11. Systems with varying particle number</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12. Quantum gases</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13. Ideal Fermi gas</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Problems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Problem_set_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem set 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Problem_set_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem set 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Problem_set_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem set 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Problem_set_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem set 4</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Solutions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions_set_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Solutions set 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions_set_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Solutions set 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions_set_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Solutions set 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions_set_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Solutions set 4</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Coursework/assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coursework assignment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Keynote slides/Slides.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture slides</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#foundations-equilibrium-of-an-isolated-system" id="toc-foundations-equilibrium-of-an-isolated-system" class="nav-link active" data-scroll-target="#foundations-equilibrium-of-an-isolated-system">2. Foundations: equilibrium of an isolated system</a>
  <ul class="collapse">
  <li><a href="#overview-the-aims-of-this-chapter" id="toc-overview-the-aims-of-this-chapter" class="nav-link" data-scroll-target="#overview-the-aims-of-this-chapter">2.1 Overview: the aims of this chapter</a></li>
  <li><a href="#microstates-and-macrostates" id="toc-microstates-and-macrostates" class="nav-link" data-scroll-target="#microstates-and-macrostates">2.2 Microstates and macrostates</a></li>
  <li><a href="#significance-of-the-weight-function-entropy" id="toc-significance-of-the-weight-function-entropy" class="nav-link" data-scroll-target="#significance-of-the-weight-function-entropy">2.3 Significance of the weight function: Entropy</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="foundations-equilibrium-of-an-isolated-system" class="level1">
<h1>2. Foundations: equilibrium of an isolated system</h1>
<section id="overview-the-aims-of-this-chapter" class="level2">
<h2 class="anchored" data-anchor-id="overview-the-aims-of-this-chapter">2.1 Overview: the aims of this chapter</h2>
<p>Consider a macroscopic system (a portion of matter, containing an Avogadro-sized number <span class="math inline">\(N\)</span> of ‘microscopic constituents’ or ‘particles’ which we shall take to be isolated from the rest of the world so that no energy (either in the form of heat or work) may enter or leave the system. The system thus has a constant total energy which we denote by <span class="math inline">\(E\)</span>.</p>
<div id="fig-isolated" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-isolated-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/isolated_system.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-isolated-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Schematic of a system isolated from its surroundings
</figcaption>
</figure>
</div>
<p>We shall develop the statistical mechanics view of such a system. Specifically we shall establish the microscopic significance of entropy and temperature, and begin to see the simplifications due to the large value of <span class="math inline">\(N\)</span>.</p>
<p>The arguments will be general (applicable irrespective of what the system actually comprises). They will be illustrated with references to two models of real systems:</p>
<ul>
<li>the ideal gas model</li>
<li>a simple model magnet</li>
</ul>
<p>The ideal gas model is familiar from PoM. The model magnet that we consider here is defined as follows (we will discuss its physical origins more fully in chapters 6 and 7).</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[ 70, 30 ]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 70.0%;justify-content: flex-start;">
<ul>
<li><p>It comprises an array of <span class="math inline">\(N\)</span> atoms (eg crystal) each with a magnetic dipole moment <span class="math inline">\({\bf m}\)</span> in an applied magnetic field <span class="math inline">\({\bf H}\)</span>. The energy of a dipole resides entirely in its interaction with the field which is given by <span class="math inline">\(\epsilon = -{\bf m} \cdot {\bf H}\)</span></p></li>
<li><p>In view of quantum mechanics (we shall not discuss the details here), <span class="math inline">\({\bf m}\)</span> is either</p>
<ul>
<li>parallel to <span class="math inline">\({\bf H}\)</span> with energy <span class="math inline">\(\epsilon = -mH\)</span> (ground state)</li>
<li>or antiparallel to <span class="math inline">\({\bf H}\)</span> with energy <span class="math inline">\(\epsilon = +mH\)</span> (excited state)</li>
</ul></li>
<li><p>Each magnetic moment then has the energy level diagram shown on the right with two levels.<br>
</p></li>
</ul>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 30.0%;justify-content: flex-start;">
<div id="fig-magen" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-magen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/simplemagen.png" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-magen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Energy-levels for one magnetic atom in a magnetic field in a simple model magnet
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="microstates-and-macrostates" class="level2">
<h2 class="anchored" data-anchor-id="microstates-and-macrostates">2.2 Microstates and macrostates</h2>
<p><em>See Mandl Chapter 2</em></p>
<p>The terms microstate and macrostate constitute two different levels of description of a macroscopic system; we define them and explore their relationship.</p>
<div id="kp1" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key point 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>microstate</strong> is a complete specification of the state of the system according to the microscopic model.</p>
</div>
</div>
<p>Thus a microstate is the most detailed description of the state of the system we can provide and is dictated by the microscopic model.</p>
<p><strong>Examples:</strong></p>
<ol type="1">
<li><p>Specifying the microstate of the model magnet means specifying the orientation of each of the <span class="math inline">\(N\)</span> dipoles as in <a href="#fig-magmicrostate" class="quarto-xref">Figure&nbsp;3 (a)</a>– or equivalently specifying which of the two rungs of its energy level ladder (cf <a href="#fig-magen" class="quarto-xref">Figure&nbsp;2</a>) it occupies.</p></li>
<li><p>Specifying the microstate of the (ideal) gas means (if we choose to use classical language) specifying the positions and velocities of each and every molecule (cf. <a href="#fig-gasmicrostate" class="quarto-xref">Figure&nbsp;3 (b)</a>).</p></li>
</ol>
<div id="fig-cmicrostate" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cmicrostate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-magmicrostate" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-magmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/spinconf.png" class="quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-cmicrostate" width="260" height="260">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-magmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) A microstate of a model magnet entails knowledge of the orientation (up or down) of each dipole. This is one possible microstate.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-cmicrostate" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-gasmicrostate" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-gasmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/gasmicrostate.png" class="quarto-figure quarto-figure-center figure-img" data-ref-parent="fig-cmicrostate" width="260" height="270">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gasmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) A microstate of a model gas entails knowledge of the positions (blue circles) and velocities (red arrows) of all the molecules. Here is one example.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-cmicrostate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3
</figcaption>
</figure>
</div>
<p>The microstate will change continually as the particles exchange energy with one another. For instance the molecules of a gas will continually be changing their position and their velocities as they collide with one another; The magnetic dipoles will undergo frequent transitions (hop from rung to rung) under the influence of their mutual interactions.</p>
<div id="kp2" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key point 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>macrostate</strong> is a limited description of the state of the system given by the values of macroscopic variables of interest</p>
</div>
</div>
<p>To understand this, we must first consider macroscopic variables.</p>
<ul>
<li><p>Macroscopic properties are properties reflecting aggregate behaviour of a large number of constituents.</p></li>
<li><p>Some macroscopic properties are fixed by constraints e.g.&nbsp;total energy <span class="math inline">\(E\)</span>, and number <span class="math inline">\(N\)</span> are fixed macroscopic properties in the systems we are considering.</p></li>
<li><p>Other macroscopic variables are free e.g.&nbsp;the number of ideal gas molecules in the left hand side of the box in <a href="#fig-gasmicrostate" class="quarto-xref">Figure&nbsp;3 (b)</a> can take on different values</p></li>
</ul>
<p>Now we see that a macrostate is a description which depends on what macroscopic properties we are interested in i.e.&nbsp;we have some freedom in choosing what are to be the macrostates. We adopt the notation of denoting the free macroscopic properties of interest (if any) <span class="math inline">\(\{\alpha\}\)</span> and we label macrostates by <span class="math inline">\(N, E, \{\alpha\}\)</span> (note that to lighten the notation <span class="math inline">\(N\)</span> is often dropped but <span class="math inline">\(E\)</span> is usually retained, however we shall retain both for the time being.)</p>
<div id="kp3" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key point 3
</div>
</div>
<div class="callout-body-container callout-body">
<p>To any one macrostate there correspond in general very many microstates.</p>
</div>
</div>
<p>The number of microstates corresponding to a macrostate <span class="math inline">\((N, E, \{\alpha\})\)</span> is called the weight of the macrostate and is denoted <span class="math inline">\(\Omega(N, E, \{\alpha\})\)</span> or more lazily <span class="math inline">\(\Omega(E, \{\alpha\})\)</span>.</p>
<p><strong>Example of model magnet:</strong></p>
<p>Here we illustrate the idea of microstates and macrostates. To begin with we do not consider any free macroscopic variables thus the macrostates are simply labelled by <span class="math inline">\(N, E\)</span> (which are fixed). We denote by <span class="math inline">\(n_i (i=1,2)\)</span> the number of dipoles in levels 1 (<span class="math inline">\(\epsilon=−mH\)</span>) and 2 (<span class="math inline">\(\epsilon=+mH)\)</span> (cf <a href="#fig-magen" class="quarto-xref">Figure&nbsp;2</a>). In fact <span class="math inline">\(n_i\)</span> are determined by the constraints:</p>
<p><span class="math display">\[
n_1+n_2=N,\hspace{1cm} n_2-n_1=\frac{E}{mH}
\]</span></p>
<p>so that</p>
<p><span class="math display">\[
n_1=\frac{1}{2}(N-\frac{E}{mH}),\hspace{1cm}n_2=\frac{1}{2}(N+\frac{E}{mH})
\]</span></p>
<p>As we stated before a microstate is a complete specification of which state every dipole is in. We now calculate the number of microstates which correspond to the values of <span class="math inline">\(n_2\)</span>, <span class="math inline">\(n_1 = N − n_2\)</span></p>
<p><span class="math display">\[
\Omega(N,E)={N\choose n_2}=\frac{N!}{(N-n_2)!n_2!}=\frac{N!}{n_1!n_2!}
\]</span></p>
<p>To lighten the notation, set <span class="math inline">\(n_2=n, n_1=N-n\)</span>, with <span class="math inline">\(n\equiv\frac{N}{2}(1+\frac{E}{NmH})\)</span> (the number of dipoles in the ‘excited’ state) we can then write</p>
<p><span id="eq-Ncn"><span class="math display">\[
\Omega(N,E)=\frac{N!}{n!(N-n)!}
\tag{1}\]</span></span></p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you don’t follow this
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Here is the reasoning, just like that in chapter <span class="math inline">\(1.4\)</span>, but now couched in the language of dipoles rather than coins. Take a hatful of <span class="math inline">\(N\)</span> dipoles; pick one which is to be in level <span class="math inline">\(i = 1\)</span>; this can be done in <span class="math inline">\(N\)</span> ways; from the remaining pool of <span class="math inline">\(N-1\)</span> pick a second destined for level <span class="math inline">\(i = 1\)</span>; this can be done in <span class="math inline">\((N - 1)\)</span> ways. Repeating until you have picked all <span class="math inline">\(n_1\)</span> required for level 1, you have a total of <span class="math inline">\(N \times (N - 1) \times (N - 2)\cdots  (N - n_1 + 1) = N!/(N - n_1)!\)</span> different hat-drawing-possibilities. All the rest of the dipoles must be in level <span class="math inline">\(2\)</span>, so there are no further choices to make. But now we must recognise that many of the ‘hat-drawing-possibilities’ actually lead to the same microstate. The microstate is defined by saying what state each dipole is in; so it doesn’t matter if dipole <span class="math inline">\(1\)</span> is the first or the last to be selected for level <span class="math inline">\(1\)</span>; to allow for this ‘overcounting’ we must divide by <span class="math inline">\(n_1\)</span>!, the number of hat drawing possibilities which assign <span class="math inline">\(n_1\)</span> specified dipoles to level <span class="math inline">\(1\)</span>.</p>
</div>
</div>
</div>
<p><strong>Explicit example <span class="math inline">\(N=3\)</span></strong></p>
<p>Here we can label the macrostates by <span class="math inline">\(n = 0, 1, 2, 3\)</span></p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[ 65, 35 ]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Macrostate</th>
<th style="text-align: center;">Microstates</th>
<th style="text-align: center;">Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(n=0,E=-3mH\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\downarrow\downarrow\downarrow\)</span></td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(n=1,E=-mH\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\downarrow\downarrow\downarrow\)</span></td>
<td style="text-align: center;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;"><span class="math inline">\(\downarrow\uparrow\uparrow\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;"><span class="math inline">\(\downarrow\downarrow\downarrow\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(n=2,E=+mH\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\uparrow\uparrow\downarrow\)</span></td>
<td style="text-align: center;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;"><span class="math inline">\(\uparrow\downarrow\uparrow\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;"><span class="math inline">\(\downarrow\uparrow\uparrow\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(n=0,E=+3mH\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\uparrow\uparrow\uparrow\)</span></td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">

</div>
</div>
</div>
<p>(Exercise: repeat for the case <span class="math inline">\(N = 4\)</span>.)</p>
<p>Taking the logarithm of <a href="#eq-Ncn" class="quarto-xref">Equation&nbsp;1</a> and invoking the Stirling approximation <span class="math inline">\(\ln N!\approx N(\ln N-1)\)</span>, good for large <span class="math inline">\(N\)</span>, we can write</p>
<p><span class="math display">\[\begin{eqnarray*}
\ln \Omega(N, E) &amp;=&amp; \ln N! - \ln n! -\ln (N - n)! \\
&amp;=&amp; N \ln N - N - n \ln n + n - (N - n) \ln(N - n) + (N - n)\\
&amp;=&amp; N \left[ \ln N - \frac{n}{N} \ln n - \left( 1 - \frac{n}{N} \right) \ln(N - n) \right]\\
&amp;=&amp; N \left[ -\frac{n}{N} \ln \left( \frac{n}{N} \right) - \left( 1 - \frac{n}{N} \right) \ln \left( 1 - \frac{n}{N} \right) \right]\\
\end{eqnarray*}\]</span></p>
<p>where we have used a ‘trick’ to write:</p>
<p><span class="math display">\[
\ln N = -\frac{n}{N} \ln \frac{1}{N} - \left( 1 - \frac{n}{N} \right) \ln \frac{1}{N}
\]</span></p>
<p>Thus <span class="math display">\[
\frac{1}{N}\ln\Omega(N,E)=s(n/N)
\]</span> where <span class="math inline">\(s(x)=-(1-x)\ln(1-x)-x\ln x\)</span></p>
<div id="fig-logmagwhts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-logmagwhts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/logmagweightfn.png" class="img-fluid figure-img" width="500">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-logmagwhts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Logarithm of the weight function, <span class="math inline">\(\ln\Omega(N,E)/N\)</span>, for the simple model magnet, plotted as a function of the fraction <span class="math inline">\(n/N\)</span> of dipoles in excited states; <span class="math inline">\(n\)</span> and <span class="math inline">\(E\)</span> are related by <span class="math inline">\(n=\frac{N}{2}(1+E/NmH)\)</span>.
</figcaption>
</figure>
</div>
<p>The logarithm of <span class="math inline">\(\Omega (N,E)\)</span> is displayed in <a href="#fig-logmagwhts" class="quarto-xref">Figure&nbsp;4</a>. Note the key features:</p>
<ul>
<li><p>When <span class="math inline">\(E\)</span> has its minimum value, <span class="math inline">\(E= -NmH\)</span> (ie <span class="math inline">\(n= 0\)</span>), then <span class="math inline">\(\ln\Omega(N,E) = 0\)</span> and <span class="math inline">\(\Omega(N,E) = 1\)</span>. There is only a single microstate associated with this macrostate.</p></li>
<li><p>As <span class="math inline">\(E\)</span> increases from its minimum, <span class="math inline">\(\ln \Omega(N,E)\)</span> increases steeply.</p></li>
<li><p>For <span class="math inline">\(E=0\)</span> (ie. <span class="math inline">\(n=N/2\)</span>) we have a maximum where <span class="math inline">\(\ln\Omega(N,E)= N\ln 2\)</span>, and <span class="math inline">\(\Omega(N,E)= 2^N\)</span>. In general the logarithm of <span class="math inline">\(\Omega\)</span> is proportional to the size of the system (we say that it is ‘extensive’)</p></li>
<li><p>Since <span class="math inline">\(\Omega = \exp(Ns(x))\)</span> the weight function is exponentially large in <span class="math inline">\(N\)</span> but the logarithm is proportional to <span class="math inline">\(N\)</span>.</p></li>
</ul>
<p>The scaling of <span class="math inline">\(\Omega(N,E)\)</span> with <span class="math inline">\(N\)</span> is demonstrated by <a href="#fig-magwhts" class="quarto-xref">Figure&nbsp;5</a> for systems of <span class="math inline">\(N=2,4,8,16,32,64\)</span> dipoles. We see that the number of microstates for each energy increases strongly with <span class="math inline">\(N\)</span> and <span class="math inline">\(\Omega(N,E)\)</span> gets narrower. This trend continues so that for Avogadro’s number of dipoles, the plot <a href="#fig-whtfnNlarge" class="quarto-xref">Figure&nbsp;6</a> of <span class="math inline">\(\Omega(E)\)</span> is practically infinitely high and infinitesimally narrow. This is the key insight of this exercise: for large <span class="math inline">\(N\)</span> there are overwhelmingly more microstates associated with the ‘equal-shares’ macrostate than there are associated with any significantly different macrostate. Problem 2.2 invites you to explore the properties of the weight function.</p>
<div id="fig-magwhts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-magwhts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/scalemagweightfn.png" class="img-fluid figure-img" width="500">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-magwhts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Weight function <span class="math inline">\(\Omega(N,E)\)</span>, for the simple model magnet comprising <span class="math inline">\(N=2,4,8,16,32,64\)</span> dipoles, plotted as a function of the fraction <span class="math inline">\(n/N\)</span> of dipoles in excited states; <span class="math inline">\(n\)</span> and <span class="math inline">\(E\)</span> are related by <span class="math inline">\(n=\frac{N}{2}(1+E/NmH)\)</span>. Note the y-axis scales and the narrowing of the function with increasing <span class="math inline">\(N\)</span>.
</figcaption>
</figure>
</div>
<p>For <span class="math inline">\(N=10^{23}\)</span> dipoles, <a href="#fig-whtfnNlarge" class="quarto-xref">Figure&nbsp;6</a> shows that the weight function is essentially a <span class="math inline">\(\delta\)</span> function</p>
<div id="fig-whtfnNlarge" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-whtfnNlarge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="NotesFigs/NAmagweightfn.png" class="img-fluid figure-img" width="400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-whtfnNlarge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: For <span class="math inline">\(N=10^{23}\)</span> dipoles the weight function <span class="math inline">\(\Omega(N,E)\)</span> is essentially a delta function.
</figcaption>
</figure>
</div>
<p>In order to understand what we mean by free macroscopic variables <span class="math inline">\(\{\alpha\}\)</span> we consider as an example the number of dipoles that are in the excited state in the left hand side of our array of <span class="math inline">\(N\)</span> dipoles. We denote this number by <span class="math inline">\(n_L\)</span>. This number is not fixed by our constraints; we only have to satisfy <span class="math inline">\(n_r + n_L = n\)</span> where <span class="math inline">\(n_r\)</span> is the number of excited dipoles in the right hand region.</p>
<p>We now label our macrostates by <span class="math inline">\(N, E, n_L\)</span></p>
<p>We can calculate the weight of a macrostate by combinatorics: in the left hand region we can choose the <span class="math inline">\(n_L\)</span> excited dipoles from <span class="math inline">\(N/2\)</span> and similarly in the right hand region <span class="math inline">\(n_r = n − n_L\)</span> are chosen from <span class="math inline">\(N/2\)</span>. Thus using Stirling’s approximation again we have that</p>
<p><span class="math display">\[
\frac{1}{N}\ln\Omega(N,0,n_L)\simeq s(n_L/(N/2))
\]</span></p>
<p>Since <span class="math inline">\(n_L\)</span> is free, it is in principle possible for the system to move between different macrostates, moreover the different available macrostates have different weights. In particular we see that macrostates with <span class="math inline">\(n_L \simeq N/4\)</span> have huge weights compared to say <span class="math inline">\(n_L \simeq N/2\)</span>. Question 2.3 explores this point</p>
</section>
<section id="significance-of-the-weight-function-entropy" class="level2">
<h2 class="anchored" data-anchor-id="significance-of-the-weight-function-entropy">2.3 Significance of the weight function: Entropy</h2>
<p>We have seen that the logarithm of the weight function is the quantity proportional to <span class="math inline">\(N\)</span>. We now state an important point relating this quantity to the entropy of a macrostate</p>
<div id="kp4" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key point 4
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
S(N,E,\{\alpha\})=k\ln\Omega(N,E,\{\alpha\})
\]</span></p>
</div>
</div>
<p>where <span class="math inline">\(k=1.381\times10^{-23} J/K\)</span> is Boltzmann’s constant. The entropy <span class="math inline">\(S(N,E,\{\alpha\})\)</span> of a macrostate is <em>defined</em> by this relation which for the moment we consider as a postulate. The logarithmic connection between entropy and probability was formulated by Boltzmann (though the above form of the equation is due to Planck). We shall refer to it as the <a href="https://en.wikipedia.org/wiki/Boltzmann%27s_entropy_formula">Planck equation</a>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>